{% load static %}
<!doctype html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ยืม–คืนอุปกรณ์กีฬา • UP-FMS</title>

    <link
      rel="icon"
      href="{% static 'img/Logo_of_University_of_Phayao.svg.png' %}"
      type="image/png"
    />
    <link rel="stylesheet" href="{% static 'assets/css/global.css' %}" />
    <link
      rel="stylesheet"
      href="{% static 'assets/css/header_equipment.css' %}"
    />
    <link
      rel="stylesheet"
      href="{% static 'assets/css/user_equipment.css' %}"
    />

    <script>
      window.BORROW_API = "{% url 'equip_borrow_api' %}";
      window.RETURN_API = "{% url 'equip_return_api' %}";
      window.RECORDS_API = "{% url 'equip_records_api' %}";
      window.FACULTY_CHECK_API = "{% url 'get_faculty_for_student_api' %}";
    </script>

    <script defer src="{% static 'js/user_header.js' %}"></script>
    <script defer src="{% static 'js/user_equipment.js' %}?v=23"></script>
  </head>

  <body data-page="equipment">
    <!-- ======= ส่วนหัว ======= -->
    <header class="topbar">
      <div class="brand">
        <img
          src="{% static 'img/logoDSASMART.png' %}"
          alt="DSA"
          class="brand-logo"
        />
      </div>

      <nav class="mainmenu" aria-label="เมนูหลัก">
        <ul>
          <li><a class="toplink" href="{% url 'user_menu' %}">หน้าหลัก</a></li>

          <li class="has-sub">
            <details>
              <summary class="toplink">
                บริการ
                <svg class="caret" viewBox="0 0 24 24">
                  <path d="M6 9l6 6 6-6" />
                </svg>
              </summary>
              <ul class="submenu">
                <li><a href="{% url 'choose' %}">เช็คอินเข้าสนาม</a></li>
                <li>
                  <a href="{% url 'user_equipment' %}">ยืม-คืนอุปกรณ์กีฬา</a>
                </li>
              </ul>
            </details>
          </li>
        </ul>
      </nav>

      <div class="righttools">
        <span class="user-btn" aria-label="ผู้ใช้ปัจจุบัน">
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden="true"
          >
            <path d="M20 21a8 8 0 0 0-16 0" />
            <circle cx="12" cy="7" r="4" />
          </svg>
          {{ display_name }}
        </span>

        <form action="{% url 'logout' %}" method="post" class="logout-form">
          {% csrf_token %}
          <button
            type="submit"
            class="logout"
            title="ออกจากระบบ"
            aria-label="ออกจากระบบ"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
              <path d="M16 17l5-5-5-5" />
              <path d="M21 12H9" />
            </svg>
            ออกจากระบบ
          </button>
        </form>
      </div>
    </header>

    <main class="wrap">
      <div class="modebar" role="tablist" aria-label="โหมด">
        <button id="tabBorrow" class="mode active" aria-selected="true">
          ยืมอุปกรณ์
        </button>
        <button id="tabReturn" class="mode" aria-selected="false">
          คืนอุปกรณ์
        </button>
      </div>

      <section id="borrowSection" class="grid">
        <div class="panel stock-card">
          <div class="stock-head">
            <div>อุปกรณ์กีฬา</div>
            <div>คงเหลือ</div>
          </div>
          <ul class="stock-list" id="stockList" aria-live="polite">
            {% for e in equipments %}
            <li><span>{{ e.name }}</span><b>{{ e.stock }}</b></li>
            {% empty %}
            <li><span>—</span><b>0</b></li>
            {% endfor %}
          </ul>
        </div>
        <form id="borrowForm" novalidate class="panel form-card">
          <label class="field">
            <span class="field-label">รหัสนิสิต</span>
            <input
              id="studentId"
              type="text"
              inputmode="numeric"
              maxlength="8"
              pattern="6\d{7}"
              title="ต้องขึ้นต้นด้วยเลข 6 และมีทั้งหมด 8 หลัก"
              placeholder="รหัสนิสิต (8 หลัก เริ่มด้วย 6)"
              autocomplete="off"
              class="input"
              aria-describedby="studentError"
              required
            />
            <small
              id="studentError"
              role="alert"
              aria-live="assertive"
              style="color: red; display: none"
            >
              ต้องขึ้นต้นด้วยเลข 6 และมีทั้งหมด 8 หลัก
            </small>
          </label>
          <label class="field">
            <span class="field-label">เลือกคณะ</span>
            <div class="select-wrap">
              <select id="faculty" required>
                {% for fac in faculties %}
                <option value="{{ fac }}">{{ fac }}</option>
                {% endfor %}
              </select>
              <svg class="caret" viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M6 9l6 6 6-6"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
              </svg>
            </div>
          </label>
          <label class="field">
            <span class="field-label">อุปกรณ์</span>
            <div class="select-wrap">
              <select id="equipment">
                {% for e in equipments %}
                <option value="{{ e.name }}">{{ e.name }}</option>
                {% empty %}
                <option disabled>ยังไม่มีข้อมูลอุปกรณ์</option>
                {% endfor %}
              </select>
              <svg class="caret" viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M6 9l6 6 6-6"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
              </svg>
            </div>
          </label>
          <label class="field">
            <span class="field-label">จำนวน</span>
            <div class="qty">
              <button type="button" class="qty-btn" data-delta="-1">−</button>
              <input
                id="qty"
                type="number"
                min="1"
                value="1"
                inputmode="numeric"
              />
              <button type="button" class="qty-btn" data-delta="1">+</button>
            </div>
          </label>
          <div class="center">
            <button id="confirmBtn" type="button" class="confirm">
              ทำการยืม
            </button>
          </div>
        </form>
      </section>

      <section id="returnSection" style="display: none">
        <h1 class="headline">รายการอุปกรณ์ที่ค้างคืน</h1>

        <div class="toolbar">
          <label class="field sid">
            <span class="legend">กรองด้วยรหัสนิสิต</span>
            <input
              id="searchStudentId"
              class="input"
              type="text"
              placeholder="พิมพ์เพื่อกรอง..."
              autocomplete="off"
            />
          </label>
          <label class="field date">
            <span class="legend">กรองด้วยวันที่ยืม</span>
            <input id="datePick" class="input" type="date" />
          </label>
          <div class="btns">
            <button id="btnSearch" class="btn btn-green" type="button">
              กรอง
            </button>
            <button id="btnToday" class="btn btn-purple" type="button">
              ล้างตัวกรอง
            </button>
          </div>
        </div>

        <div class="table-scroll" id="returnTableWrap">
          <table class="table-return" aria-label="ตารางคืนอุปกรณ์">
            <colgroup>
              <col style="width: 72px" />   <!-- ลำดับ -->
              <col style="width: 140px" />  <!-- รหัสนิสิต -->
              <col style="width: 220px" />  <!-- คณะ -->
              <col style="width: 280px" />  <!-- รายการ -->
              <col style="width: 130px" />  <!-- จำนวนที่ยืม -->
              <col style="width: 150px" />  <!-- จำนวนค้างคืน -->
              <col style="width: 160px" />  <!-- จำนวนที่จะคืน -->
              <col style="width: 110px" />  <!-- ปุ่มคืน -->
            </colgroup>
            <thead>
              <tr>
                <th>ลำดับ</th>
                <th>รหัสนิสิต</th>
                <th>คณะ</th>
                <th>รายการ</th>
                <th>จำนวนที่ยืม</th>
                <th>จำนวนค้างคืน</th>
                <th>จำนวนที่จะคืน</th>
                <th>คืน</th>
              </tr>
            </thead>
            <tbody id="returnTableBody">
              {% for item in pending_items %}
              <tr data-borrow-date="{{ item.borrow_date|date:'Y-m-d' }}">
                <td>{{ forloop.counter }}</td>
                <td>{{ item.student_id }}</td>
                <td>{{ item.faculty }}</td>
                <td>{{ item.equipment_name }}</td>
                <td>{{ item.quantity_borrowed }}</td>
                <td>{{ item.quantity_pending }}</td>
                <td>
                  <input
                    type="number"
                    min="1"
                    max="{{ item.quantity_pending }}"
                    value="1"
                    style="width: 80px"
                  />
                </td>
                <td><button type="button" class="btn-return">คืน</button></td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="8" style="text-align: center">
                  ยังไม่มีรายการค้างคืน
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <div class="sheet" id="sheetBorrow" aria-hidden="true">
      <div class="sheet-card">
        <div class="sheet-title">ทำการยืม<br />เสร็จสิ้น</div>
        <div class="sheet-icon">✔</div>
      </div>
    </div>
  </body>
</html>
