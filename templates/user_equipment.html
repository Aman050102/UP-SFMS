{% load static %}
<!doctype html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ยืมอุปกรณ์กีฬา • UP-FMS</title>

    <link
      rel="icon"
      href="{% static 'img/Logo_of_University_of_Phayao.svg.png' %}"
      type="image/png"
    />
    <link rel="stylesheet" href="{% static 'assets/css/global.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/user_header.css' %}" />
    <link
      rel="stylesheet"
      href="{% static 'assets/css/user_equipment.css' %}"
    />

    <script defer src="{% static 'js/user_header.js' %}"></script>
    <script defer src="{% static 'js/user_equipment.js' %}?v=2"></script>
  </head>

  <body data-page="equipment">
    <!-- ======= ส่วนหัว ======= -->
    <header class="topbar">
      <div class="brand">
        <img
          src="{% static 'img/logoDSASMART.png' %}"
          alt="DSA"
          class="brand-logo"
        />
      </div>

      <nav class="mainmenu" aria-label="เมนูหลัก">
        <ul>
          <li><a class="toplink" href="{% url 'user_menu' %}">หน้าหลัก</a></li>

          <li class="has-sub">
            <details>
              <summary class="toplink">
                บริการ
                <svg class="caret" viewBox="0 0 24 24">
                  <path d="M6 9l6 6 6-6" />
                </svg>
              </summary>
              <ul class="submenu">
                <li><a href="{% url 'choose' %}">เช็คอินเข้าสนาม</a></li>
                <li>
                  <a href="{% url 'user_equipment' %}">ยืม-คืนอุปกรณ์กีฬา</a>
                </li>
                <li>
                  <a href="{% url 'badminton_booking' %}">จองสนามแบดมินตัน</a>
                </li>
              </ul>
            </details>
          </li>
        </ul>
      </nav>

      <div class="righttools">
        <span class="user-btn" aria-label="ผู้ใช้ปัจจุบัน">
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden="true"
          >
            <path d="M20 21a8 8 0 0 0-16 0" />
            <circle cx="12" cy="7" r="4" />
          </svg>
          {{ display_name }}
        </span>

        <form action="{% url 'logout' %}" method="post" class="logout-form">
          {% csrf_token %}
          <button
            type="submit"
            class="logout"
            title="ออกจากระบบ"
            aria-label="ออกจากระบบ"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
              <path d="M16 17l5-5-5-5" />
              <path d="M21 12H9" />
            </svg>
            ออกจากระบบ
          </button>
        </form>
      </div>
    </header>

    <!-- Main -->
    <main class="wrap">
      <!-- โหมด -->
      <div class="modebar" role="tablist" aria-label="โหมด">
        <a
          class="mode active"
          aria-current="page"
          href="{% url 'user_equipment' %}"
        >
          ✓ ยืมอุปกรณ์
        </a>
        <a class="mode" href="{% url 'user_equipment_return' %}">
          คืนอุปกรณ์
        </a>
      </div>

      <section class="grid">
        <!-- สต็อก -->
        <div class="panel stock-card">
          <div class="stock-head">
            <div>อุปกรณ์กีฬา</div>
            <div>คงเหลือ</div>
          </div>
          <ul class="stock-list" id="stockList" aria-live="polite">
            {% for e in equipments %}
            <li><span>{{ e.name }}</span><b>{{ e.stock }}</b></li>
            {% empty %}
            <li><span>—</span><b>0</b></li>
            {% endfor %}
          </ul>
        </div>

        <!-- ฟอร์ม -->
        <!-- CHANGED: ครอบด้วย form เพื่อดัก submit และแชร์ validation กับ JS -->
        <form id="borrowForm" novalidate class="panel form-card">
          <!-- รหัสนิสิต -->
          <label class="field">
            <span class="field-label">รหัสนิสิต</span>
            <input
              id="studentId"
              type="text"
              inputmode="numeric"
              maxlength="8"
              pattern="6\d{7}"
              title="ต้องขึ้นต้นด้วยเลข 6 และมีทั้งหมด 8 หลัก"
              placeholder="รหัสนิสิต (8 หลัก เริ่มด้วย 6)"
              class="input"
              aria-describedby="studentError"
              required
            />

            <small id="studentError" style="color: red; display: none">
              ต้องขึ้นต้นด้วยเลข 6 และมีทั้งหมด 8 หลัก
            </small>
          </label>

          <script>
            (function () {
              const studentInput = document.getElementById("studentId");
              const studentError = document.getElementById("studentError");
              const RE = /^6\d{7}$/;

              studentInput.addEventListener("input", function (e) {
                const cursorPos = e.target.selectionStart;
                const digits = (e.target.value || "").replace(/\D/g, "").slice(0, 8);
                if (digits !== e.target.value) {
                  e.target.value = digits;
                  try { e.target.setSelectionRange(cursorPos, cursorPos); } catch (__) {}
                }
                // ซ่อน error ระหว่างพิมพ์ จนกว่าจะครบ 8 หลัก
                if (digits.length < 8) {
                  studentError.style.display = "none";
                } else {
                  studentError.style.display = RE.test(digits) ? "none" : "block";
                }
              });

              studentInput.addEventListener("blur", function (e) {
                const v = e.target.value || "";
                studentError.style.display = RE.test(v) ? "none" : "block";
              });
            })();
          </script>

          <!-- เลือกคณะ -->
          <label class="field">
            <span class="field-label">เลือกคณะ</span>
            <div class="select-wrap">
              <select id="faculty">
                {% if faculties %} {% for fac in faculties %}
                <option value="{{ fac }}">{{ fac }}</option>
                {% endfor %} {% else %}
                <!-- fallback เผื่อยังไม่ส่งรายการคณะจาก view -->
                <option value="">คณะ…</option>
                <option>คณะการจัดการ</option>
                <option>คณะวิทยาศาสตร์</option>
                <option>คณะวิศวกรรมศาสตร์</option>
                <option>คณะพยาบาลศาสตร์</option>
                {% endif %}
              </select>
              <svg class="caret" viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M6 9l6 6 6-6"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
              </svg>
            </div>
          </label>

          <!-- อุปกรณ์ -->
          <label class="field">
            <span class="field-label">อุปกรณ์</span>
            <div class="select-wrap">
              <select id="equipment">
                {% for e in equipments %}
                <option value="{{ e.name }}">{{ e.name }}</option>
                {% empty %}
                <option disabled>ยังไม่มีข้อมูลอุปกรณ์</option>
                {% endfor %}
              </select>
              <svg class="caret" viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M6 9l6 6 6-6"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
              </svg>
            </div>
          </label>

          <!-- จำนวน -->
          <label class="field">
            <span class="field-label">จำนวน</span>
            <div class="qty">
              <button type="button" class="qty-btn" data-delta="-1">−</button>
              <input
                id="qty"
                type="number"
                min="1"
                value="1"
                inputmode="numeric"
              />
              <button type="button" class="qty-btn" data-delta="1">+</button>
            </div>
          </label>

          <div class="center">
            <!-- CHANGED: บังคับ type="button" -->
            <button id="confirmBtn" type="button" class="confirm">ทำการยืม</button>
          </div>
        </form>
      </section>
    </main>

    <!-- Sheets -->
    <div class="sheet" id="sheetBorrow" aria-hidden="true">
      <div class="sheet-card">
        <div class="sheet-title">ทำการยืม<br />เสร็จสิ้น</div>
        <div class="sheet-icon">✔</div>
      </div>
    </div>

    <script>
      window.BORROW_API = "{% url 'equip_borrow_api' %}";
      window.RETURN_API = "{% url 'equip_return_api' %}";
    </script>
  </body>
</html>
