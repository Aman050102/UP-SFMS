{% load static %}
<!doctype html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{{ title }} {{ month_label }}</title>

    <link
      rel="icon"
      href="{% static 'img/Logo_of_University_of_Phayao.svg.png' %}"
      type="image/png"
    />
    <link rel="stylesheet" href="{% static 'assets/css/global.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/admin_header.css' %}" />
    <style>
      body {
        margin: 0;
        background: #fff;
        font-family: "Sarabun", system-ui, sans-serif;
      }
      .toolbar {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: flex-end;
        padding: 10px 16px;
        border-bottom: 1px solid #e5e7eb;
        background: #fff;
      }
      .toolbar .title {
        margin-right: auto;
        font-weight: 700;
      }
      /* ใช้หน้าตาเดียวกับปุ่มออกจากระบบ */
      .btn-like-logout {
        border: 1px solid #e5e7eb;
        background: #fff;
        color: #111827;
        border-radius: 12px;
        padding: 8px 14px;
        font-weight: 800;
        cursor: pointer;
        transition: 0.15s;
      }
      .btn-like-logout:hover {
        background: #f9fafb;
      }
      iframe {
        width: 100%;
        height: calc(100vh - 60px);
        border: 0;
        display: block;
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        <img
          src="{% static 'img/logoDSASMART.png' %}"
          alt="DSA"
          class="brand-logo"
        />
      </div>

      <nav class="mainmenu" aria-label="เมนูหลัก">
        <ul>
          <li>
            <a class="toplink" href="{% url 'staff_console' %}">หน้าหลัก</a>
          </li>

          <li class="has-sub">
            <a href="#" class="toplink" aria-haspopup="true">
              จัดการข้อมูล
              <svg class="caret" viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M6 9l6 6 6-6"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
              </svg>
            </a>
            <ul class="submenu" role="menu">
              <li>
                <a role="menuitem" href="{% url 'staff_equipment' %}"
                  >ยืม-คืนอุปกรณ์กีฬา</a
                >
              </li>
              <li>
                <a role="menuitem" href="{% url 'staff_badminton_booking' %}"
                  >จองสนามแบดมินตัน</a
                >
              </li>
            </ul>
          </li>

          <li class="has-sub">
            <a href="#" class="toplink" aria-haspopup="true">
              รายงาน
              <svg class="caret" viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M6 9l6 6 6-6"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
              </svg>
            </a>
            <ul class="submenu" role="menu">
              <li>
                <a role="menuitem" href="{% url 'checkin_report' %}"
                  >ข้อมูลการเข้าใช้สนาม</a
                >
              </li>
              <li>
                <a role="menuitem" href="{% url 'staff_borrow_stats' %}"
                  >ข้อมูลสถิติการยืม-คืน</a
                >
              </li>
            </ul>
          </li>
        </ul>
      </nav>

      <div class="righttools">
        <span class="user-btn" aria-label="ผู้ใช้ปัจจุบัน"
          >{{ display_name }}</span
        >
        <form action="{% url 'logout' %}" method="post" class="logout-form">
          {% csrf_token %}
          <button
            type="submit"
            class="logout"
            title="ออกจากระบบ"
            aria-label="ออกจากระบบ"
          >
            ออกจากระบบ
          </button>
        </form>
      </div>
    </header>

    <div class="toolbar">
      <div class="title">{{ title }} {{ month_label }}</div>
      <a class="btn-like-logout" href="{{ source_pdf_url }}?dl=1">ดาวน์โหลด</a>
      <button class="btn-like-logout" id="btnPrint">พิมพ์</button>
      <button class="btn-like-logout" id="btnRegen">สร้างใหม่</button>
    </div>

    <!-- แก้สำคัญ: ใช้ source_pdf_url -->
    <iframe id="frame" src="{{ source_pdf_url }}" title="PDF"></iframe>

    <script>
      const frame = document.getElementById("frame");
      document.getElementById("btnPrint").addEventListener("click", () => {
        const w = frame.contentWindow;
        if (!w) return;
        if (w.document && w.document.readyState === "complete") {
          w.focus();
          w.print();
        } else {
          frame.addEventListener(
            "load",
            () => {
              frame.contentWindow.focus();
              frame.contentWindow.print();
            },
            { once: true },
          );
        }
      });

      document
        .getElementById("btnRegen")
        .addEventListener("click", async (ev) => {
          const btn = ev.currentTarget;
          btn.disabled = true;
          btn.textContent = "กำลังสร้าง...";
          try {
            const r = await fetch("{{ build_url }}");
            const j = await r.json();
            if (!j.ok) alert(j.message || "สร้างไฟล์ไม่สำเร็จ");
            else frame.src = "{{ source_pdf_url }}" + "?t=" + Date.now(); // refresh PDF
          } catch (e) {
            alert("สร้างไฟล์ไม่สำเร็จ");
          } finally {
            btn.disabled = false;
            btn.textContent = "สร้างใหม่";
          }
        });
    </script>
  </body>
</html>
